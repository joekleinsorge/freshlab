---
- name: Ensure required tools are available
  ansible.builtin.file:
    path: "{{ item }}"
    state: file
  loop:
    - /usr/bin/podman
    - /usr/bin/rpm-ostree
  register: tool_check
  ignore_errors: true

- name: Fail if required tools are missing
  ansible.builtin.fail:
    msg: "Required tools are missing on CoreOS. Please ensure the system is properly provisioned."
  when: tool_check.failed

- name: Configure kernel parameters
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    state: present
    reload: yes
  loop:
    - {name: "fs.inotify.max_queued_events", value: "16384"}
    - {name: "fs.inotify.max_user_instances", value: "8192"}
    - {name: "fs.inotify.max_user_watches", value: "524288"}

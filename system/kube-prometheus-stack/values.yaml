kube-prometheus-stack:
  prometheus-node-exporter:
    hostNetwork: false
    extraArgs:
      - --collector.systemd
      - --collector.processes
      - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/.+)($|/)
      - --collector.netclass.ignored-devices=^(veth.*|cali.*|tunl.*|dummy.*)$
      - --collector.textfile
      - --collector.cpu.info
      - --collector.meminfo_numa
      - --collector.network_route
      - --collector.schedstat
      - --collector.thermal_zone
    resources:
      limits:
        cpu: 250m
        memory: 180Mi
      requests:
        cpu: 100m
        memory: 50Mi
    serviceMonitor:
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: instance
      scrapeTimeout: 30s
      interval: 30s
  grafana:
    adminPassword: password
    deploymentStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 0
        maxUnavailable: 1
    ingress:
      enabled: true
      ingressClassName: cilium
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        hajimari.io/appName: Grafana
        hajimari.io/icon: chart-line
      hosts:
        - &host grafana-monitoring.kleinsorge.dev
      tls:
        - secretName: grafana-general-tls
          hosts:
            - *host
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki.loki:3100
    grafana.ini:
      server:
        root_url: https://grafana-monitoring.kleinsorge.dev
      auth:
        disable_login_form: false
        oauth_auto_login: false
      security:
        allow_embedding: true
        cookie_secure: true
        strict_transport_security: true
      users:
        allow_sign_up: false
      analytics:
        reporting_enabled: false
        check_for_updates: false
      dashboards:
        default_home_dashboard_path: /var/lib/grafana/dashboards/default-home.json
      unified_alerting:
        enabled: true
    resources:
      limits:
        cpu: 300m
        memory: 500Mi
      requests:
        cpu: 100m
        memory: 128Mi
    persistence:
      enabled: true
      size: 10Gi
      storageClassName: rook-ceph-block
  prometheus-blackbox-exporter:
    enabled: true
  prometheus:
    prometheusSpec:
      # Allow slow WAL replay on restart without startup probe flapping.
      maximumStartupDurationSeconds: 3600
      ruleSelectorNilUsesHelmValues: false
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      probeSelectorNilUsesHelmValues: false
      ruleNamespaceSelector: {}
      serviceMonitorNamespaceSelector: {}
      podMonitorNamespaceSelector: {}
      probeNamespaceSelector: {}
      retention: 15d
      retentionSize: "10GB"
      resources:
        requests:
          cpu: 500m
          memory: 2Gi
        limits:
          cpu: 1000m
          memory: 4Gi
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: rook-ceph-block
            resources:
              requests:
                storage: 50Gi
      walCompression: true
      enableFeatures:
        - remote-write-receiver
      additionalScrapeConfigs:
        - job_name: blackbox-http
          metrics_path: /probe
          params:
            module: [http_2xx]
          static_configs:
            - targets:
                - grafana.kleinsorge.dev
                - kindle-weather.kleinsorge.dev
          relabel_configs:
            - source_labels: [__address__]
              target_label: __param_target
            - source_labels: [__param_target]
              target_label: instance
            - target_label: __address__
              replacement: kube-prometheus-stack-prometheus-blackbox-exporter.kube-prometheus-stack.svc.cluster.local:9115
